<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TFR</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Three.js -->
  <script src="https://unpkg.com/three@0.158.0/build/three.min.js"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>


  <style>
    body { margin: 0; background: #f8fafc; }
    #bg { position: fixed; inset: 0; z-index: 0; }
    #app { position: relative; z-index: 10; }
  </style>
</head>

<body>

<canvas id="bg"></canvas>

<div id="app" class="min-h-screen flex flex-col py-12 gap-8 px-4">
  
  <!-- TITLE AND IMAGE -->
  <div class="text-center mb-8">
    <h1 class="text-6xl font-bold mb-4">TFR</h1>
    <img id="topImage" src="TFR.png" alt="Obesity Ranking Table" class="mx-auto max-w-2xl rounded-lg shadow-lg">
  </div>
  
  <!-- MAIN CONTENT: Apps -->
  <div class="flex flex-col items-center gap-8 max-w-2xl mx-auto w-full">
  
  <!-- ================= BMR CALCULATOR ================= -->
  <div class="w-full max-w-sm bg-white p-4 rounded-xl shadow space-y-3">
    <h1 class="text-lg font-bold text-center">BMR Calculator</h1>
    <p class="text-xs text-gray-600 text-center mb-2">Basal Metabolic Rate - energy expended while at rest</p>
    
    <div class="space-y-2">
      <div>
        <label class="block text-xs font-medium text-gray-700 mb-1">Age</label>
        <input id="bmrAge" type="number" min="15" max="80" value="20" placeholder="20" class="w-full border p-1.5 rounded text-sm">
        <p class="text-xs text-gray-500 mt-0.5">ages 15 - 80</p>
      </div>
      
      <div>
        <label class="block text-xs font-medium text-gray-700 mb-1">Gender</label>
        <div class="flex gap-4">
          <label class="flex items-center">
            <input type="radio" name="bmrGender" value="male" checked class="mr-1">
            <span class="text-xs">Male</span>
          </label>
          <label class="flex items-center">
            <input type="radio" name="bmrGender" value="female" class="mr-1">
            <span class="text-xs">Female</span>
          </label>
        </div>
      </div>
      
      <div class="grid grid-cols-2 gap-2">
        <div>
          <label class="block text-xs font-medium text-gray-700 mb-1">Height</label>
          <input id="bmrHeight" type="number" value="170" placeholder="170" class="w-full border p-1.5 rounded text-sm">
          <p class="text-xs text-gray-500 mt-0.5">cm</p>
        </div>
        
        <div>
          <label class="block text-xs font-medium text-gray-700 mb-1">Weight</label>
          <input id="bmrWeight" type="number" value="69" placeholder="69" class="w-full border p-1.5 rounded text-sm">
          <p class="text-xs text-gray-500 mt-0.5">kg</p>
        </div>
      </div>
      
      <button id="bmrCalculate" class="w-full bg-indigo-600 text-white py-1.5 rounded hover:bg-indigo-700 text-sm">Calculate</button>
      
      <div id="bmrResult" class="text-center p-3 bg-gray-50 rounded-lg hidden">
        <p class="text-xs text-gray-600">BMR =</p>
        <p id="bmrValue" class="text-xl font-bold text-indigo-600"></p>
        <p class="text-xs text-gray-600">Calories/day</p>
      </div>
    </div>
  </div>
  
  <!-- ================= FASTING TIMER ================= -->
  <div class="w-full max-w-md bg-white p-6 rounded-xl shadow space-y-4">
    <h1 class="text-xl font-bold text-center">Fasting Timer</h1>

    <div id="fastTimer" class="text-center text-3xl font-mono">00:00:00</div>

    <div class="flex gap-2">
      <button id="fastStart" class="flex-1 bg-emerald-600 text-white py-2 rounded">START</button>
      <button id="fastStop" class="flex-1 border py-2 rounded">STOP</button>
    </div>

    <div id="fastStatus" class="text-center text-sm text-green-600"></div>
  </div>

  <!-- ================= CALORIES & PROTEIN TRACKING ================= -->
  <div class="w-full max-w-md bg-white p-6 rounded-xl shadow space-y-4 mt-4">
    <div class="grid grid-cols-2 gap-2">
      <input id="docCalories" type="number" placeholder="Calories" class="border p-2 rounded">
      <input id="docProtein" type="number" placeholder="Protein (g)" class="border p-2 rounded">
    </div>

    <button id="docSave" class="w-full bg-indigo-600 text-white py-2 rounded">Save</button>

    <div id="docStatus" class="text-center text-sm text-green-600"></div>
    
    <!-- Calorie Tracking AI Bot -->
    <button id="toggleChatbot" class="w-full bg-purple-600 text-white py-2 rounded hover:bg-purple-700 flex items-center justify-center gap-2">
      <span>ü§ñ Calorie Tracking AI</span>
    </button>
    
    <!-- Botpress Chatbot Container -->
    <div id="chatbotContainer" class="hidden mt-4 border rounded-lg overflow-hidden" style="height: 500px;">
      <iframe 
        id="botpressIframe"
        src="https://cdn.botpress.cloud/webchat/v3.5/shareable.html?configUrl=https://files.bpcontent.cloud/2025/12/13/14/20251213144310-3T2R5ADA.json"
        style="width: 100%; height: 100%; border: none;"
        allow="microphone; camera">
      </iframe>
    </div>
  </div>
  
  </div> <!-- End apps -->
  
  <!-- DASHBOARD BELOW -->
  <div class="w-full max-w-4xl mx-auto mt-8">
    <div class="bg-white/90 backdrop-blur border rounded-xl p-6 shadow">
      <h2 class="text-lg font-bold mb-4 text-center">Dashboard</h2>
      
      <div class="flex flex-col gap-6">
        <!-- Fasting Timer Stats -->
        <div>
          <h3 class="text-sm font-semibold text-gray-700 mb-2">Fasting Timer</h3>
          <div id="dashboardSaaS" class="text-xs space-y-1 mb-2">
            <div class="text-gray-500">Loading...</div>
          </div>
          <div style="height: 150px; position: relative;">
            <canvas id="chartSaaS"></canvas>
          </div>
        </div>
        
        <!-- Calories & Protein Stats -->
        <div>
          <h3 class="text-sm font-semibold text-gray-700 mb-2">Calories & Protein</h3>
          <div id="dashboardBF" class="text-xs space-y-1 mb-2">
            <div class="text-gray-500">Loading...</div>
          </div>
          <div style="height: 150px; position: relative;">
            <canvas id="chartBF"></canvas>
          </div>
        </div>
      </div>
    </div>
  </div> <!-- End dashboard -->
  
</div> <!-- End main flex container -->


<script>
/* ===== HELPERS ===== */
const pad = n => String(n).padStart(2,"0");
const fmt = s => `${pad(s/3600|0)}:${pad(s%3600/60|0)}:${pad(s%60)}`;

/* ===== LOCALSTORAGE UTILITIES ===== */
const STORAGE_KEYS = {
  doctor_logs: 'tfr_doctor_logs',
  saas_timer_logs: 'tfr_saas_timer_logs'
};

// Load data from localStorage
function loadFromStorage(key) {
  try {
    const data = localStorage.getItem(key);
    return data ? JSON.parse(data) : [];
  } catch (e) {
    console.error(`Error loading ${key}:`, e);
    return [];
  }
}

// Save data to localStorage
function saveToStorage(key, data) {
  try {
    localStorage.setItem(key, JSON.stringify(data));
    return true;
  } catch (e) {
    console.error(`Error saving ${key}:`, e);
    return false;
  }
}

// Add entry to storage
function addToStorage(key, entry) {
  const data = loadFromStorage(key);
  entry.id = entry.id || Date.now(); // Use timestamp as ID
  entry.created_at = entry.created_at || new Date().toISOString();
  data.unshift(entry); // Add to beginning
  saveToStorage(key, data);
  return entry;
}

// Update entry in storage
function updateInStorage(key, id, updates) {
  const data = loadFromStorage(key);
  const index = data.findIndex(item => item.id === id);
  if (index !== -1) {
    data[index] = { ...data[index], ...updates };
    saveToStorage(key, data);
    return true;
  }
  return false;
}

// Delete entry from storage
function deleteFromStorage(key, id) {
  const data = loadFromStorage(key);
  const filtered = data.filter(item => item.id !== id);
  saveToStorage(key, filtered);
  return filtered.length !== data.length;
}

/* ===== BF% APP ===== */
document.getElementById("docSave").onclick = async () => {
  const docStatus = document.getElementById("docStatus");
  const docCalories = document.getElementById("docCalories");
  const docProtein = document.getElementById("docProtein");
  try {
    const entry = {
      date: new Date().toISOString().slice(0,10),
      hours: 0,
      calories: +docCalories.value || 0,
      protein: +docProtein.value || 0,
      gym: false,
      cal_track: false,
      protein_only: false,
      home_dumbbell: false,
      score: 0
    };
    
    addToStorage(STORAGE_KEYS.doctor_logs, entry);
    docStatus.textContent = "Saved ‚úÖ";
    
    // Clear inputs after successful save
    docCalories.value = "";
    docProtein.value = "";
    loadDashboard(); // Refresh dashboard
  } catch (err) {
    docStatus.textContent = "‚ùå Error: " + err.message;
    console.error("Calories & Protein save error:", err);
  }
};

/* ===== BOTPRESS CALORIE TRACKING AI ===== */
// Toggle chatbot visibility
document.getElementById("toggleChatbot").onclick = () => {
  const container = document.getElementById("chatbotContainer");
  const button = document.getElementById("toggleChatbot");
  
  if (container.classList.contains("hidden")) {
    container.classList.remove("hidden");
    button.innerHTML = '<span>‚ùå Close AI Chat</span>';
  } else {
    container.classList.add("hidden");
    button.innerHTML = '<span>ü§ñ Calorie Tracking AI</span>';
  }
};

/* ===== FASTING TIMER ===== */
let fStart = null, fInt = null;

document.getElementById("fastStart").onclick = () => {
  if (fInt) return;
  fStart = Date.now();
  const fastTimer = document.getElementById("fastTimer");
  fInt = setInterval(() => {
    fastTimer.textContent = fmt((Date.now() - fStart) / 1000 | 0);
  }, 1000);
};

document.getElementById("fastStop").onclick = async () => {
  if (!fStart) {
    const fastStatus = document.getElementById("fastStatus");
    fastStatus.textContent = "‚ö†Ô∏è Please start the timer first";
    return;
  }

  clearInterval(fInt);
  fInt = null;
  const fastTimer = document.getElementById("fastTimer");
  const fastStatus = document.getElementById("fastStatus");

  const seconds = (Date.now() - fStart) / 1000 | 0;
  fStart = null; // Reset after getting the value

  try {
    const entry = {
      date: new Date().toISOString().slice(0,10),
      seconds: seconds
    };
    
    addToStorage(STORAGE_KEYS.saas_timer_logs, entry);
    fastStatus.textContent = `Saved ${seconds}s ‚úÖ`;
    loadDashboard(); // Refresh dashboard
  } catch (err) {
    fastStatus.textContent = "‚ùå Error: " + err.message;
    console.error("Fasting Timer save error:", err);
  }

  fastTimer.textContent = "00:00:00";
};

/* ===== BMR CALCULATOR ===== */
document.getElementById("bmrCalculate").onclick = () => {
  const age = parseFloat(document.getElementById("bmrAge").value) || 20;
  const height = parseFloat(document.getElementById("bmrHeight").value) || 170;
  const weight = parseFloat(document.getElementById("bmrWeight").value) || 69;
  const gender = document.querySelector('input[name="bmrGender"]:checked').value;
  
  // Validate inputs
  if (age < 15 || age > 80) {
    alert("Age must be between 15 and 80");
    return;
  }
  
  // Mifflin-St Jeor Equation
  let bmr;
  if (gender === "male") {
    bmr = 10 * weight + 6.25 * height - 5 * age + 5;
  } else {
    bmr = 10 * weight + 6.25 * height - 5 * age - 161;
  }
  
  // Round to nearest whole number
  bmr = Math.round(bmr);
  
  // Display result
  const resultDiv = document.getElementById("bmrResult");
  const bmrValue = document.getElementById("bmrValue");
  bmrValue.textContent = bmr.toLocaleString();
  resultDiv.classList.remove("hidden");
};

/* ===== DASHBOARD ===== */
let chartSaaS = null, chartBF = null;

function loadDashboard() {
  // Load Fasting Timer data (last 14 days)
  const allData = loadFromStorage(STORAGE_KEYS.saas_timer_logs);
  const saasData = [...allData].sort((a, b) => {
    const dateA = new Date(a.created_at || 0);
    const dateB = new Date(b.created_at || 0);
    return dateB - dateA;
  }).slice(0, 14);
  
  const saasEl = document.getElementById("dashboardSaaS");
  if (saasData && saasData.length > 0) {
    const latest = saasData[0];
    const hours = (latest.seconds / 3600).toFixed(2);
    saasEl.innerHTML = `
      <div class="text-gray-600">Latest: ${latest.date}</div>
      <div class="font-semibold text-emerald-600">${hours}h (${latest.seconds}s)</div>
    `;
    
    // Create/update chart
    const ctx = document.getElementById("chartSaaS").getContext("2d");
    const sorted = [...saasData].reverse();
    if (chartSaaS) chartSaaS.destroy();
    chartSaaS = new Chart(ctx, {
      type: "line",
      data: {
        labels: sorted.map(d => new Date(d.date).toLocaleDateString("en-US", { month: "short", day: "numeric" })),
        datasets: [{
          label: "Hours",
          data: sorted.map(d => (d.seconds / 3600).toFixed(2)),
          borderColor: "rgb(16, 185, 129)",
          backgroundColor: "rgba(16, 185, 129, 0.1)",
          tension: 0.4,
          fill: true
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { display: false } },
        scales: {
          y: { beginAtZero: true, ticks: { font: { size: 9 } } },
          x: { ticks: { font: { size: 8 }, maxRotation: 45 } }
        }
      }
    });
  } else {
    saasEl.innerHTML = '<div class="text-gray-400">No data yet</div>';
  }
  
  // Load Calories & Protein data (last 14 days)
  const allBfData = loadFromStorage(STORAGE_KEYS.doctor_logs);
  const bfData = [...allBfData].sort((a, b) => {
    const dateA = new Date(a.created_at || 0);
    const dateB = new Date(b.created_at || 0);
    return dateB - dateA;
  }).slice(0, 14);
  
  const bfEl = document.getElementById("dashboardBF");
  if (bfData && bfData.length > 0) {
    const latest = bfData[0];
    bfEl.innerHTML = `
      <div class="text-gray-600">Latest: ${latest.date}</div>
      <div class="font-semibold text-pink-600">Cal: ${latest.calories} | Prot: ${latest.protein}g</div>
    `;
    
    // Create/update chart
    const ctx = document.getElementById("chartBF").getContext("2d");
    const sorted = [...bfData].reverse();
    if (chartBF) chartBF.destroy();
    chartBF = new Chart(ctx, {
      type: "line",
      data: {
        labels: sorted.map(d => new Date(d.date).toLocaleDateString("en-US", { month: "short", day: "numeric" })),
        datasets: [{
          label: "Score",
          data: sorted.map(d => d.score || 0),
          borderColor: "rgb(236, 72, 153)",
          backgroundColor: "rgba(236, 72, 153, 0.1)",
          tension: 0.4,
          fill: true
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { display: false } },
        scales: {
          y: { beginAtZero: true, ticks: { font: { size: 9 } } },
          x: { ticks: { font: { size: 8 }, maxRotation: 45 } }
        }
      }
    });
  } else {
    bfEl.innerHTML = '<div class="text-gray-400">No data yet</div>';
  }
}

// Load dashboard on page load
loadDashboard();
(()=>{
  const scene = new THREE.Scene();
  const cam = new THREE.PerspectiveCamera(75, innerWidth/innerHeight, 0.1, 1000);
  const ren = new THREE.WebGLRenderer({ canvas: bg, alpha: true });
  ren.setSize(innerWidth, innerHeight);
  cam.position.z = 6;

  const s = new THREE.Mesh(
    new THREE.SphereGeometry(3,64,64),
    new THREE.MeshBasicMaterial({ color: 0x6366f1, wireframe:true })
  );
  scene.add(s);

  (function anim(){
    requestAnimationFrame(anim);
    s.rotation.y += 0.003;
    ren.render(scene, cam);
  })();
})();
</script>

</body>
</html>